{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #f0f2f5;
        color: #333;
    }

    .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .header h1 {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .main-container {
        display: flex;
        height: calc(100vh - 76px);
    }

    .sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
    }

    .sidebar-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        background: #ecf0f1;
        color: #666;
    }

    .tab-btn.active {
        color: white;
    }

    .tab-btn.incidents.active {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .tab-btn.instructions.active {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .search-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: #3498db;
    }

    .items-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .item-card {
        background: #f8f9fa;
        border: 2px solid transparent;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .item-card:hover {
        background: #e8f4fc;
    }

    .item-card.active {
        border-color: #3498db;
        background: #e8f4fc;
    }

    .item-card.incident {
        border-left: 4px solid #e74c3c;
    }

    .item-card.instruction {
        border-left: 4px solid #3498db;
    }

    .item-card-title {
        font-weight: 600;
        margin-bottom: 5px;
    }

    .item-card-meta {
        font-size: 0.85rem;
        color: #888;
    }

    .item-card-category {
        font-size: 0.8rem;
        color: #666;
        margin-top: 4px;
    }

    .add-item-btn {
        margin: 15px;
        width: calc(100% - 30px);
        padding: 15px;
        border: 2px dashed #ccc;
        border-radius: 10px;
        background: transparent;
        color: #888;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .add-item-btn:hover {
        border-color: #3498db;
        color: #3498db;
        background: #e8f4fc;
    }

    .editor {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .editor-empty {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
        font-size: 1.2rem;
    }

    .editor-content {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
    }

    .editor-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .editor-section h3 {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
    }

    .form-row {
        display: flex;
        gap: 20px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .pages-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        align-items: center;
    }

    .page-tab {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
    }

    .page-tab:hover {
        border-color: #3498db;
    }

    .page-tab.active {
        background: #3498db;
        border-color: #3498db;
        color: white;
    }

    .add-page-btn {
        padding: 10px 20px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        background: transparent;
        cursor: pointer;
        color: #888;
        transition: all 0.3s;
    }

    .add-page-btn:hover {
        border-color: #27ae60;
        color: #27ae60;
    }

    .page-editor {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .actions-list {
        margin-top: 15px;
    }

    .action-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

    .action-number {
        width: 30px;
        height: 30px;
        background: #3498db;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .action-input {
        flex: 1;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
    }

    .action-input:focus {
        outline: none;
        border-color: #3498db;
    }

    .action-remove {
        width: 36px;
        height: 36px;
        border: none;
        background: #fee;
        color: #e74c3c;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s;
    }

    .action-remove:hover {
        background: #e74c3c;
        color: white;
    }

    .action-drag {
        width: 36px;
        height: 36px;
        border: none;
        background: #f0f0f0;
        color: #888;
        border-radius: 8px;
        cursor: grab;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .add-action-btn {
        width: 100%;
        padding: 12px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        background: transparent;
        color: #888;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.3s;
    }

    .add-action-btn:hover {
        border-color: #27ae60;
        color: #27ae60;
    }

    .image-upload {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #fafafa;
    }

    .image-upload:hover {
        border-color: #3498db;
        background: #e8f4fc;
    }

    .image-upload.has-image {
        padding: 10px;
    }

    .image-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
    }

    .image-upload-text {
        color: #888;
        margin-top: 10px;
    }

    .image-upload-icon {
        font-size: 3rem;
        color: #ccc;
    }

    .editor-footer {
        padding: 20px 30px;
        background: white;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .json-preview {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 10px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
        max-height: 400px;
        overflow: auto;
        white-space: pre-wrap;
    }

    .locations-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .location-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
    }

    .location-checkbox:hover {
        background: #e8f4fc;
        border-color: #3498db;
    }

    .location-checkbox.checked {
        background: #e8f5e9;
        border-color: #27ae60;
    }

    .location-checkbox input {
        display: none;
    }

    .location-checkbox .checkbox-icon {
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: transparent;
        transition: all 0.2s;
    }

    .location-checkbox.checked .checkbox-icon {
        background: #27ae60;
        border-color: #27ae60;
        color: white;
    }

    .location-checkbox .location-code {
        font-weight: 600;
    }

    @media (max-width: 1024px) {
        .main-container {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            height: auto;
            max-height: 300px;
        }
        .form-row {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<header class="header">
    <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π</h1>
    <div class="header-actions">
        <a href="./" class="btn btn-primary">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <button class="btn btn-secondary" onclick="showCategoriesModal()">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
        <button class="btn btn-secondary" onclick="showExportModal()">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn btn-secondary" onclick="showImportModal()">–ò–º–ø–æ—Ä—Ç</button>
    </div>
</header>

<div class="main-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-tabs">
                <button class="tab-btn incidents active" onclick="switchTab('incidents')">–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã</button>
                <button class="tab-btn instructions" onclick="switchTab('instructions')">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</button>
            </div>
            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="filterList(this.value)">
        </div>
        <div class="items-list" id="items-list"></div>
        <button class="add-item-btn" onclick="addNewItem()">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π</button>
    </aside>

    <main class="editor">
        <div class="editor-empty" id="editor-empty">
            <div style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 20px;">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
                <div>–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è<br>–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</div>
            </div>
        </div>

        <div class="editor-content" id="editor-content" style="display: none;">
            <div class="editor-section">
                <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-control" id="item-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—Ç–µ–∫–ª–∞ —Ä—É–±–∞—à–∫–∞">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–¢–∏–ø</label>
                        <select class="form-control" id="item-type" onchange="updateCategoryOptions()">
                            <option value="incident">–ò–Ω—Ü–∏–¥–µ–Ω—Ç</option>
                            <option value="instruction">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-control" id="item-category">
                            <option value="">-- –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ --</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 0.5;">
                        <label>ID</label>
                        <input type="text" class="form-control" id="item-id" placeholder="–ê–≤—Ç–æ" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>–õ–æ–∫–∞—Ü–∏–∏ (–≥–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è)</label>
                    <div id="locations-checkboxes" class="locations-checkboxes"></div>
                </div>
            </div>

            <div class="editor-section">
                <h3>–°—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
                <div class="pages-tabs" id="pages-tabs"></div>
                <div class="page-editor" id="page-editor"></div>
            </div>
        </div>

        <div class="editor-footer" id="editor-footer" style="display: none;">
            <button class="btn btn-danger" onclick="deleteCurrentItem()">–£–¥–∞–ª–∏—Ç—å</button>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="duplicateItem()">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-primary" onclick="saveCurrentItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </main>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
    <div class="modal" style="max-width: 700px;">
        <h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
        <div class="json-preview" id="json-output"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('export-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button class="btn btn-primary" onclick="copyJson()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-success" onclick="downloadJson()">–°–∫–∞—á–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="import-modal">
    <div class="modal">
        <h3>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
        <div class="form-group">
            <label>–í—Å—Ç–∞–≤—å—Ç–µ JSON –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
            <textarea class="form-control" id="import-json" rows="10" placeholder='{"incidents": [...], "instructions": [...]}'></textarea>
        </div>
        <input type="file" id="import-file" accept=".json" style="display: none;" onchange="loadFile(event)">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('import-modal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            <button class="btn btn-primary" onclick="importData()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirm-modal">
    <div class="modal">
        <h3 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
        <p id="confirm-message">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('confirm-modal')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" id="confirm-btn">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- Categories Modal -->
<div class="modal-overlay" id="categories-modal">
    <div class="modal" style="max-width: 600px;">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h3>
        <div class="sidebar-tabs" style="margin-bottom: 20px;">
            <button class="tab-btn incidents" id="cat-tab-incidents" onclick="switchCategoryTab('incident')">–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã</button>
            <button class="tab-btn instructions" id="cat-tab-instructions" onclick="switchCategoryTab('instruction')">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</button>
        </div>
        <div id="categories-list-modal" style="max-height: 400px; overflow-y: auto;"></div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <h4 style="margin-bottom: 15px;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
            <div class="form-row">
                <div class="form-group">
                    <input type="text" class="form-control" id="new-cat-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                </div>
                <div class="form-group" style="flex: 0.3;">
                    <input type="text" class="form-control" id="new-cat-icon" placeholder="–ò–∫–æ–Ω–∫–∞" value="üìÅ">
                </div>
                <div class="form-group" style="flex: 0.3;">
                    <input type="color" class="form-control" id="new-cat-color" value="#3498db" style="height: 42px; padding: 4px;">
                </div>
            </div>
            <button class="btn btn-success" onclick="addCategory()" style="width: 100%;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('categories-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Data from server
    let data = {
        incidents: {{ incidents | tojson | safe }},
        instructions: {{ instructions | tojson | safe }}
    };

    let categories = [];
    let locations = [];
    let currentTab = 'incidents';
    let currentItem = null;
    let currentPageIndex = 0;
    let currentCategoryTab = 'incident';

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([loadCategories(), loadLocations()]);
        renderItemsList();
    });

    async function loadCategories() {
        try {
            categories = await api('/categories');
        } catch (error) {
            console.error('Failed to load categories:', error);
        }
    }

    async function loadLocations() {
        try {
            locations = await api('/locations');
        } catch (error) {
            console.error('Failed to load locations:', error);
        }
    }

    function getCategoriesForType(type) {
        return categories.filter(c => c.item_type === type);
    }

    function updateCategoryOptions() {
        const select = document.getElementById('item-category');
        const type = document.getElementById('item-type').value;
        const cats = getCategoriesForType(type);

        select.innerHTML = '<option value="">-- –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ --</option>' +
            cats.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');

        if (currentItem && currentItem.category_id) {
            select.value = currentItem.category_id;
        }
    }

    function renderLocationsCheckboxes() {
        const container = document.getElementById('locations-checkboxes');
        const selectedIds = currentItem?.location_ids || [];

        container.innerHTML = locations.map(loc => {
            const isChecked = selectedIds.includes(loc.id);
            return `
                <label class="location-checkbox ${isChecked ? 'checked' : ''}" onclick="toggleLocation(${loc.id}, this)">
                    <span class="checkbox-icon">${isChecked ? '‚úì' : ''}</span>
                    <span class="location-code">${loc.code}</span>
                </label>
            `;
        }).join('');
    }

    function toggleLocation(locId, labelEl) {
        if (!currentItem.location_ids) {
            currentItem.location_ids = [];
        }

        const idx = currentItem.location_ids.indexOf(locId);
        if (idx > -1) {
            currentItem.location_ids.splice(idx, 1);
            labelEl.classList.remove('checked');
            labelEl.querySelector('.checkbox-icon').textContent = '';
        } else {
            currentItem.location_ids.push(locId);
            labelEl.classList.add('checked');
            labelEl.querySelector('.checkbox-icon').textContent = '‚úì';
        }
    }

    // Categories modal
    function showCategoriesModal() {
        currentCategoryTab = currentTab === 'incidents' ? 'incident' : 'instruction';
        renderCategoriesModal();
        document.getElementById('categories-modal').classList.add('show');
    }

    function switchCategoryTab(type) {
        currentCategoryTab = type;
        renderCategoriesModal();
    }

    function renderCategoriesModal() {
        // Update tabs
        document.getElementById('cat-tab-incidents').classList.toggle('active', currentCategoryTab === 'incident');
        document.getElementById('cat-tab-instructions').classList.toggle('active', currentCategoryTab === 'instruction');

        const cats = getCategoriesForType(currentCategoryTab);
        const container = document.getElementById('categories-list-modal');

        if (cats.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
            return;
        }

        container.innerHTML = cats.map(cat => `
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                <span style="font-size: 1.5rem;">${cat.icon}</span>
                <span style="flex: 1; font-weight: 500;">${cat.name}</span>
                <span style="background: ${cat.color}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">${cat.items_count}</span>
                <button class="btn btn-danger btn-sm" onclick="deleteCategory(${cat.id})" style="padding: 6px 12px;">‚úï</button>
            </div>
        `).join('');
    }

    async function addCategory() {
        const name = document.getElementById('new-cat-name').value.trim();
        const icon = document.getElementById('new-cat-icon').value.trim() || 'üìÅ';
        const color = document.getElementById('new-cat-color').value;

        if (!name) {
            showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
            return;
        }

        try {
            const newCat = await api('/categories', {
                method: 'POST',
                body: {
                    name,
                    item_type: currentCategoryTab,
                    icon,
                    color
                }
            });

            categories.push(newCat);
            document.getElementById('new-cat-name').value = '';
            renderCategoriesModal();
            showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    async function deleteCategory(id) {
        try {
            await api(`/categories/${id}`, { method: 'DELETE' });
            categories = categories.filter(c => c.id !== id);
            renderCategoriesModal();
            showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    function switchTab(tab) {
        currentTab = tab;
        currentItem = null;
        currentPageIndex = 0;

        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn.${tab}`).classList.add('active');

        renderItemsList();
        hideEditor();
    }

    function renderItemsList() {
        const list = document.getElementById('items-list');
        const items = data[currentTab];

        list.innerHTML = items.map((item, index) => {
            const cat = categories.find(c => c.id === item.category_id);
            const catLabel = cat ? `${cat.icon} ${cat.name}` : '';
            const locCodes = (item.location_ids || []).map(id => {
                const loc = locations.find(l => l.id === id);
                return loc ? loc.code : '';
            }).filter(c => c).join(', ');
            return `
                <div class="item-card ${currentTab === 'incidents' ? 'incident' : 'instruction'} ${currentItem && currentItem.id === item.id ? 'active' : ''}"
                     onclick="selectItem(${index})">
                    <div class="item-card-title">${item.title}</div>
                    <div class="item-card-meta">${item.pages.length} —Å—Ç—Ä.${locCodes ? ` ‚Ä¢ ${locCodes}` : ''}</div>
                    ${catLabel ? `<div class="item-card-category">${catLabel}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    function filterList(query) {
        const items = data[currentTab];
        const filtered = items.filter(item =>
            item.title.toLowerCase().includes(query.toLowerCase())
        );

        const list = document.getElementById('items-list');
        list.innerHTML = filtered.map((item) => {
            const index = items.findIndex(i => i.id === item.id);
            return `
                <div class="item-card ${currentTab === 'incidents' ? 'incident' : 'instruction'} ${currentItem && currentItem.id === item.id ? 'active' : ''}"
                     onclick="selectItem(${index})">
                    <div class="item-card-title">${item.title}</div>
                    <div class="item-card-meta">${item.pages.length} —Å—Ç—Ä.</div>
                </div>
            `;
        }).join('');
    }

    function selectItem(index) {
        currentItem = { ...data[currentTab][index] };
        currentItem._index = index;
        currentPageIndex = 0;
        showEditor();
        renderItemsList();
    }

    function showEditor() {
        document.getElementById('editor-empty').style.display = 'none';
        document.getElementById('editor-content').style.display = 'block';
        document.getElementById('editor-footer').style.display = 'flex';

        document.getElementById('item-title').value = currentItem.title;
        document.getElementById('item-type').value = currentTab === 'incidents' ? 'incident' : 'instruction';
        document.getElementById('item-id').value = currentItem.id;

        updateCategoryOptions();
        if (currentItem.category_id) {
            document.getElementById('item-category').value = currentItem.category_id;
        }

        renderLocationsCheckboxes();
        renderPagesTabs();
        renderPageEditor();
    }

    function hideEditor() {
        document.getElementById('editor-empty').style.display = 'flex';
        document.getElementById('editor-content').style.display = 'none';
        document.getElementById('editor-footer').style.display = 'none';
    }

    function renderPagesTabs() {
        const container = document.getElementById('pages-tabs');
        container.innerHTML = currentItem.pages.map((page, index) => `
            <button class="page-tab ${index === currentPageIndex ? 'active' : ''}" onclick="switchPage(${index})">
                ${index + 1}. ${page.title.substring(0, 15)}${page.title.length > 15 ? '...' : ''}
            </button>
        `).join('') + `
            <button class="add-page-btn" onclick="addPage()">+ –°—Ç—Ä–∞–Ω–∏—Ü–∞</button>
        `;
    }

    function switchPage(index) {
        saveCurrentPage();
        currentPageIndex = index;
        renderPagesTabs();
        renderPageEditor();
    }

    function renderPageEditor() {
        const page = currentItem.pages[currentPageIndex];
        const container = document.getElementById('page-editor');

        container.innerHTML = `
            <div class="page-header">
                <h4>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPageIndex + 1} –∏–∑ ${currentItem.pages.length}</h4>
                ${currentItem.pages.length > 1 ? `
                    <button class="btn btn-danger btn-sm" onclick="deletePage(${currentPageIndex})">–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                ` : ''}
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
                    <input type="text" class="form-control" id="page-title" value="${page.title}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã">
                </div>
                <div class="form-group">
                    <label>–†–µ–≥–ª–∞–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏</label>
                    <input type="text" class="form-control" id="page-time" value="${page.time}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10 –º–∏–Ω—É—Ç">
                </div>
            </div>

            <div class="form-group">
                <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                <div class="image-upload ${page.image ? 'has-image' : ''}" onclick="document.getElementById('image-input').click()">
                    ${page.image ? `
                        <img src="${page.image}" class="image-preview" alt="Preview">
                        <div class="image-upload-text">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å</div>
                    ` : `
                        <div class="image-upload-icon">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                        <div class="image-upload-text">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                    `}
                </div>
                <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="uploadImage(event)">
                <input type="text" class="form-control" id="page-image" value="${page.image || ''}" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="margin-top: 10px;">
            </div>

            <div class="form-group">
                <label>–î–µ–π—Å—Ç–≤–∏—è</label>
                <div class="actions-list" id="actions-list">
                    ${page.actions.map((action, index) => `
                        <div class="action-item">
                            <span class="action-drag">:</span>
                            <span class="action-number">${index + 1}</span>
                            <input type="text" class="action-input" value="${action}" onchange="updateAction(${index}, this.value)">
                            <button class="action-remove" onclick="removeAction(${index})">x</button>
                        </div>
                    `).join('')}
                </div>
                <button class="add-action-btn" onclick="addAction()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</button>
            </div>
        `;
    }

    function saveCurrentPage() {
        if (!currentItem) return;

        const page = currentItem.pages[currentPageIndex];
        const titleEl = document.getElementById('page-title');
        const timeEl = document.getElementById('page-time');
        const imageEl = document.getElementById('page-image');

        if (titleEl) page.title = titleEl.value;
        if (timeEl) page.time = timeEl.value;
        if (imageEl) page.image = imageEl.value;
    }

    function addPage() {
        saveCurrentPage();
        currentItem.pages.push({
            title: "–ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞",
            time: "5 –º–∏–Ω—É—Ç",
            image: "",
            actions: ["–î–µ–π—Å—Ç–≤–∏–µ 1"]
        });
        currentPageIndex = currentItem.pages.length - 1;
        renderPagesTabs();
        renderPageEditor();
    }

    function deletePage(index) {
        if (currentItem.pages.length <= 1) {
            showToast('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É', 'error');
            return;
        }

        currentItem.pages.splice(index, 1);
        if (currentPageIndex >= currentItem.pages.length) {
            currentPageIndex = currentItem.pages.length - 1;
        }
        renderPagesTabs();
        renderPageEditor();
    }

    function addAction() {
        saveCurrentPage();
        currentItem.pages[currentPageIndex].actions.push("–ù–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ");
        renderPageEditor();
    }

    function removeAction(index) {
        saveCurrentPage();
        currentItem.pages[currentPageIndex].actions.splice(index, 1);
        renderPageEditor();
    }

    function updateAction(index, value) {
        currentItem.pages[currentPageIndex].actions[index] = value;
    }

    async function uploadImage(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Show loading state
        const uploadDiv = document.querySelector('.image-upload');
        const originalContent = uploadDiv.innerHTML;
        uploadDiv.innerHTML = '<div style="padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(API_BASE + '/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Upload failed');
            }

            const result = await response.json();

            // Update image URL with base path
            const imageUrl = BASE_PATH + '/' + result.url;
            document.getElementById('page-image').value = imageUrl;
            currentItem.pages[currentPageIndex].image = imageUrl;
            renderPageEditor();
            showToast('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');

        } catch (error) {
            uploadDiv.innerHTML = originalContent;
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
        }
    }

    function addNewItem() {
        const newItem = {
            id: null,  // No ID = new item, will be created via POST
            title: currentTab === 'incidents' ? "–ù–æ–≤—ã–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç" : "–ù–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
            location_ids: [],
            pages: [
                {
                    title: "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1",
                    time: "5 –º–∏–Ω—É—Ç",
                    image: "",
                    actions: ["–î–µ–π—Å—Ç–≤–∏–µ 1"]
                }
            ]
        };

        data[currentTab].push(newItem);
        renderItemsList();
        selectItem(data[currentTab].length - 1);
        showToast('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç');
    }

    async function saveCurrentItem() {
        if (!currentItem) return;

        saveCurrentPage();
        currentItem.title = document.getElementById('item-title').value;

        const categorySelect = document.getElementById('item-category');
        const categoryId = categorySelect.value ? parseInt(categorySelect.value) : null;
        currentItem.category_id = categoryId;

        // Prepare data for API
        const itemData = {
            title: currentItem.title,
            item_type: currentTab === 'incidents' ? 'incident' : 'instruction',
            category_id: categoryId,
            location_ids: currentItem.location_ids || [],
            pages: currentItem.pages.map(page => ({
                title: page.title,
                time: page.time,
                image: page.image,
                actions: [...page.actions]  // Deep copy actions
            }))
        };

        try {
            let savedItem;
            if (currentItem.id) {
                // Update existing
                savedItem = await api(`/items/${currentItem.id}`, {
                    method: 'PUT',
                    body: itemData
                });
            } else {
                // Create new
                savedItem = await api('/items', {
                    method: 'POST',
                    body: itemData
                });
            }

            // Update local data from server response
            const idx = currentItem._index;
            const serverItem = {
                id: savedItem.id,
                title: savedItem.title,
                category_id: savedItem.category_id,
                location_ids: savedItem.location_ids || (savedItem.locations ? savedItem.locations.map(l => l.id) : []),
                pages: savedItem.pages.map(p => ({
                    title: p.title,
                    time: p.time,
                    image: p.image || '',
                    actions: p.actions.map(a => a.text)
                }))
            };

            data[currentTab][idx] = serverItem;
            currentItem = { ...serverItem };
            currentItem._index = idx;

            renderItemsList();
            showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
        }
    }

    function deleteCurrentItem() {
        if (!currentItem) return;

        document.getElementById('confirm-title').textContent = '–£–¥–∞–ª–µ–Ω–∏–µ';
        document.getElementById('confirm-message').textContent = `–£–¥–∞–ª–∏—Ç—å "${currentItem.title}"?`;
        document.getElementById('confirm-btn').onclick = async () => {
            try {
                if (currentItem.id) {
                    await api(`/items/${currentItem.id}`, { method: 'DELETE' });
                }

                data[currentTab].splice(currentItem._index, 1);
                currentItem = null;
                hideEditor();
                renderItemsList();
                closeModal('confirm-modal');
                showToast('–£–¥–∞–ª–µ–Ω–æ');
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
            }
        };
        document.getElementById('confirm-modal').classList.add('show');
    }

    function duplicateItem() {
        if (!currentItem) return;

        saveCurrentPage();
        const newItem = JSON.parse(JSON.stringify(currentItem));
        newItem.id = null;  // New item - will be created via POST
        newItem.title += ' (–∫–æ–ø–∏—è)';
        delete newItem._index;

        data[currentTab].push(newItem);
        renderItemsList();
        selectItem(data[currentTab].length - 1);
        showToast('–°–æ–∑–¥–∞–Ω–∞ –∫–æ–ø–∏—è');
    }

    async function showExportModal() {
        if (currentItem) saveCurrentPage();

        try {
            const exportData = await api('/export');
            document.getElementById('json-output').textContent = JSON.stringify(exportData, null, 2);
            document.getElementById('export-modal').classList.add('show');
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
        }
    }

    function copyJson() {
        const json = document.getElementById('json-output').textContent;
        navigator.clipboard.writeText(json);
        showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
    }

    function downloadJson() {
        const json = document.getElementById('json-output').textContent;
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'knowledge-base.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω', 'success');
    }

    function showImportModal() {
        document.getElementById('import-json').value = '';
        document.getElementById('import-modal').classList.add('show');
    }

    function loadFile(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('import-json').value = e.target.result;
            };
            reader.readAsText(file);
        }
    }

    async function importData() {
        try {
            const json = document.getElementById('import-json').value;
            const imported = JSON.parse(json);

            await api('/import', {
                method: 'POST',
                body: imported
            });

            // Refresh data
            const newData = await api('/export');
            data.incidents = newData.incidents;
            data.instructions = newData.instructions;

            currentItem = null;
            hideEditor();
            renderItemsList();
            closeModal('import-modal');
            showToast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ JSON', 'error');
        }
    }

    // Close modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('show');
            }
        });
    });
</script>
{% endblock %}
