{% extends "base.html" %}

{% block title %}–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞{% endblock %}

{% block extra_css %}
<style>
    :root {
        --color-danger: #D32F2F;
        --color-danger-dark: #B71C1C;
        --color-success: #388E3C;
        --color-success-dark: #1B5E20;
        --color-primary: #1976D2;
        --color-primary-dark: #0D47A1;
        --color-warning: #F57C00;
        --color-warning-dark: #E65100;
        --color-dark: #263238;
        --color-darker: #1a1a2e;
    }

    body {
        background: linear-gradient(135deg, var(--color-darker) 0%, #16213e 100%);
        color: #fff;
        overflow-x: hidden;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 16px;
        min-height: 100vh;
    }

    /* Header */
    .header {
        padding: 0 0 20px 0;
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    h1 {
        font-size: 1.6rem;
        margin: 0;
    }

    .fullscreen-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1rem;
        min-height: 48px;
    }

    .fullscreen-btn.active {
        background: rgba(56, 142, 60, 0.6);
    }

    /* Search box */
    .search-box {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 18px 20px 18px 54px;
        font-size: 1.1rem;
        border: 2px solid #3d5a80;
        border-radius: 12px;
        background: #0f0f23;
        color: #fff;
        outline: none;
        box-sizing: border-box;
    }

    .search-input:focus {
        border-color: #4dabf7;
    }

    .search-input::placeholder {
        color: #6c757d;
    }

    .search-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.3rem;
        color: #6c757d;
    }

    /* Main buttons */
    .main-buttons {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
    }

    .main-btn {
        flex: 1;
        padding: 28px 20px;
        font-size: 1.4rem;
        font-weight: bold;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s;
        min-height: 90px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .main-btn.incidents {
        background: linear-gradient(135deg, var(--color-danger) 0%, var(--color-danger-dark) 100%);
        color: white;
    }

    .main-btn.instructions {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
        color: white;
    }

    .main-btn.active {
        transform: scale(0.98);
        box-shadow: inset 0 4px 10px rgba(0,0,0,0.3);
    }

    /* Back button */
    .back-nav {
        margin-bottom: 16px;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #4a5568;
        color: white;
        border: none;
        padding: 16px 28px;
        font-size: 1.1rem;
        border-radius: 12px;
        cursor: pointer;
        min-height: 56px;
    }

    .back-btn:active { background: #2d3748; }

    /* Section title */
    .section-title {
        font-size: 1.3rem;
        color: #a0aec0;
        margin-bottom: 16px;
        padding-left: 8px;
    }

    /* Category buttons */
    .category-btn {
        display: flex;
        align-items: center;
        gap: 16px;
        width: 100%;
        padding: 24px;
        margin-bottom: 12px;
        font-size: 1.3rem;
        font-weight: bold;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        text-align: left;
        min-height: 75px;
        color: white;
        transition: transform 0.2s, opacity 0.2s;
    }

    .category-btn:active {
        transform: scale(0.98);
        opacity: 0.9;
    }

    .category-btn .icon { font-size: 1.8rem; }

    .category-btn .count {
        margin-left: auto;
        background: rgba(0,0,0,0.2);
        padding: 6px 14px;
        border-radius: 16px;
        font-size: 1rem;
    }

    /* Item buttons */
    .item-btn {
        display: block;
        width: 100%;
        padding: 22px 24px;
        margin-bottom: 10px;
        font-size: 1.2rem;
        background: #2d3748;
        color: white;
        border: 3px solid #4a5568;
        border-radius: 12px;
        text-align: left;
        cursor: pointer;
        min-height: 70px;
        transition: all 0.2s;
    }

    .item-btn:active {
        background: #4a5568;
        border-color: #68d391;
    }

    .item-pages-count {
        display: block;
        font-size: 0.95rem;
        color: rgba(255,255,255,0.6);
        margin-top: 6px;
    }

    .no-results {
        text-align: center;
        padding: 40px;
        color: rgba(255,255,255,0.5);
        font-size: 1.2rem;
    }

    /* Search results */
    .search-result-category {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.5);
        margin-top: 4px;
    }

    /* Screens */
    .screen { display: none; }
    .screen.active { display: block; }

    /* ========== FULLSCREEN MODAL ========== */
    .modal-overlay {
        background: rgba(0, 0, 0, 0.95);
        padding: 0;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #fff;
    }

    .modal-header {
        background: linear-gradient(135deg, var(--color-warning) 0%, var(--color-warning-dark) 100%);
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        min-height: 70px;
    }

    .modal-header h2 {
        font-size: 1.4rem;
        margin: 0;
        flex: 1;
    }

    .modal-close-btn {
        background: rgba(255, 255, 255, 0.25);
        border: none;
        color: white;
        padding: 14px 28px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        min-height: 52px;
    }

    .progress-container {
        background: #e0e0e0;
        height: 8px;
        flex-shrink: 0;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-success) 0%, #4CAF50 100%);
        transition: width 0.3s ease;
    }

    .modal-main {
        flex: 1;
        display: flex;
        overflow: hidden;
        background: #f5f5f5;
    }

    .modal-image-side {
        flex: 0 0 40%;
        max-width: 40%;
        background: var(--color-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-image-side img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 12px;
    }

    .no-image {
        color: rgba(255,255,255,0.3);
        font-size: 1.2rem;
        text-align: center;
    }

    .modal-content-side {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .page-info {
        padding: 16px 24px;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
        flex-shrink: 0;
    }

    .page-title {
        font-size: 1.4rem;
        color: #333;
        margin: 0 0 8px 0;
        font-weight: 600;
    }

    .time-badge {
        display: inline-block;
        background: var(--color-primary);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 500;
    }

    .actions-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
    }

    .action-item {
        background: #fff;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid #e0e0e0;
        min-height: 64px;
    }

    .action-item:hover {
        border-color: var(--color-primary);
    }

    .action-item.checked {
        background: #E8F5E9;
        border-color: var(--color-success);
    }

    .action-checkbox {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid #bbb;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.2rem;
        color: transparent;
        transition: all 0.2s;
    }

    .action-item.checked .action-checkbox {
        background: var(--color-success);
        border-color: var(--color-success);
        color: white;
    }

    .action-number {
        background: var(--color-primary);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .action-item.checked .action-number {
        background: var(--color-success);
    }

    .action-text {
        flex: 1;
        font-size: 1.15rem;
        color: #333;
        line-height: 1.4;
    }

    .action-item.checked .action-text {
        color: var(--color-success-dark);
    }

    .modal-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: #fff;
        border-top: 1px solid #e0e0e0;
        flex-shrink: 0;
        gap: 16px;
    }

    .nav-btn {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
        border: none;
        color: white;
        padding: 18px 36px;
        border-radius: 14px;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        min-height: 60px;
        min-width: 140px;
        transition: all 0.3s;
    }

    .nav-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .nav-btn.finish {
        background: linear-gradient(135deg, var(--color-success) 0%, var(--color-success-dark) 100%);
    }

    .page-indicator-bottom {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 12px;
    }

    #page-dots {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
    }

    .page-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .page-dot.active {
        background: var(--color-warning);
        transform: scale(1.3);
    }

    .page-dot.completed {
        background: var(--color-success);
    }

    .page-number-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        min-width: 80px;
        text-align: center;
    }

    @media (max-width: 900px) {
        .modal-main {
            flex-direction: column;
        }

        .modal-image-side {
            flex: 0 0 35%;
            max-width: 100%;
            max-height: 35%;
        }
    }

    @media (max-width: 600px) {
        .main-btn {
            padding: 22px 16px;
            font-size: 1.1rem;
        }

        .modal-image-side {
            flex: 0 0 30%;
            max-height: 30%;
        }

        .nav-btn {
            padding: 14px 20px;
            min-width: 100px;
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <div class="header-top">
            <h1 id="page-header-title">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h1>
            <button class="fullscreen-btn" onclick="toggleFullscreen()" id="fullscreen-btn">
                <span id="fullscreen-icon">‚õ∂</span>
            </button>
        </div>
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="global-search" placeholder="–ü–æ–∏—Å–∫..." oninput="handleSearch()">
        </div>
    </div>

    <!-- Screen: Main (choose type) -->
    <div id="screen-main" class="screen active">
        <div class="main-buttons">
            <button class="main-btn incidents" onclick="showScreen('incidents')">
                –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã
            </button>
            <button class="main-btn instructions" onclick="showScreen('instructions')">
                –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            </button>
        </div>
    </div>

    <!-- Screen: Categories list -->
    <div id="screen-categories" class="screen">
        <div class="back-nav">
            <button class="back-btn" onclick="showScreen('main')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <div class="section-title" id="categories-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</div>
        <div id="categories-list"></div>
    </div>

    <!-- Screen: Items in category -->
    <div id="screen-items" class="screen">
        <div class="back-nav">
            <button class="back-btn" onclick="goBackFromItems()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <div class="section-title" id="items-title">–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã</div>
        <div id="items-list"></div>
    </div>

    <!-- Screen: Search results -->
    <div id="screen-search" class="screen">
        <div class="back-nav">
            <button class="back-btn" onclick="clearSearch()">‚Üê –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫</button>
        </div>
        <div class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</div>
        <div id="search-results"></div>
    </div>
</div>

<!-- Fullscreen Modal -->
<div class="modal-overlay" id="modal" onclick="closeModalOutside(event)">
    <div class="modal" id="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>
            <button class="modal-close-btn" onclick="closeModal('modal')">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>

        <div class="modal-main">
            <div class="modal-image-side">
                <img id="modal-img" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                <div class="no-image" id="no-image" style="display: none;">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            </div>

            <div class="modal-content-side">
                <div class="page-info">
                    <h3 class="page-title" id="page-title">–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞</h3>
                    <span class="time-badge" id="modal-time">‚è± 5 –º–∏–Ω—É—Ç</span>
                </div>

                <div class="actions-container" id="actions-container"></div>
            </div>
        </div>

        <div class="modal-navigation">
            <button class="nav-btn" id="prev-btn" onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>

            <div class="page-indicator-bottom">
                <div id="page-dots"></div>
                <span class="page-number-text" id="page-number">1 / 3</span>
            </div>

            <button class="nav-btn" id="next-btn" onclick="changePage(1)">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // State
    let currentScreen = 'main';
    let currentType = null;  // 'incident' or 'instruction'
    let currentCategoryId = null;
    let categories = [];
    let allItems = [];
    let currentItem = null;
    let currentPage = 0;
    let checkedActions = [];

    // Swipe support
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isSwiping = false;

    // Load initial data
    async function loadData() {
        try {
            const [incidentCats, instructionCats, incidents, instructions] = await Promise.all([
                api('/categories?item_type=incident'),
                api('/categories?item_type=instruction'),
                api('/incidents'),
                api('/instructions')
            ]);
            categories = [...incidentCats, ...instructionCats];
            allItems = [
                ...incidents.map(i => ({...i, item_type: 'incident'})),
                ...instructions.map(i => ({...i, item_type: 'instruction'}))
            ];
        } catch (error) {
            console.error('Failed to load data:', error);
        }
    }

    loadData();

    // Screen navigation
    function showScreen(screen, options = {}) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

        // Clear search and reset search context when navigating (except to search screen)
        if (screen !== 'search') {
            document.getElementById('global-search').value = '';
            searchContext = { type: null, categoryId: null, previousScreen: 'main' };
        }

        if (screen === 'main') {
            document.getElementById('screen-main').classList.add('active');
            document.getElementById('page-header-title').textContent = '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π';
            document.getElementById('global-search').placeholder = '–ü–æ–∏—Å–∫...';
            currentType = null;
            currentCategoryId = null;
        } else if (screen === 'incidents' || screen === 'instructions') {
            currentType = screen === 'incidents' ? 'incident' : 'instruction';
            currentCategoryId = null;
            document.getElementById('screen-categories').classList.add('active');
            document.getElementById('page-header-title').textContent = screen === 'incidents' ? '–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã' : '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏';
            document.getElementById('categories-title').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª';
            document.getElementById('global-search').placeholder = screen === 'incidents' ? '–ü–æ–∏—Å–∫ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞...' : '–ü–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...';
            renderCategories();
        } else if (screen === 'items') {
            document.getElementById('screen-items').classList.add('active');
            currentCategoryId = options.categoryId;
            const cat = categories.find(c => c.id === currentCategoryId);
            document.getElementById('items-title').textContent = cat ? `${cat.icon} ${cat.name}` : '–í—Å–µ';
            document.getElementById('global-search').placeholder = currentCategoryId !== null ? '–ü–æ–∏—Å–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ...' : '–ü–æ–∏—Å–∫...';
            renderItems();
        } else if (screen === 'search') {
            document.getElementById('screen-search').classList.add('active');
        }

        currentScreen = screen;
    }

    function goBackFromItems() {
        if (currentType) {
            showScreen(currentType === 'incident' ? 'incidents' : 'instructions');
        } else {
            showScreen('main');
        }
    }

    // Render categories
    function renderCategories() {
        const list = document.getElementById('categories-list');
        const typeCats = categories.filter(c => c.item_type === currentType);

        if (typeCats.length === 0) {
            // No categories, show all items directly
            showScreen('items', { categoryId: null });
            return;
        }

        // Add "All" category
        let html = `
            <button class="category-btn" style="background: #4a5568;" onclick="showScreen('items', {categoryId: null})">
                <span class="icon">üìã</span>
                <span>–í—Å–µ</span>
                <span class="count">${allItems.filter(i => i.item_type === currentType).length}</span>
            </button>
        `;

        html += typeCats.map(cat => `
            <button class="category-btn" style="background: ${cat.color};" onclick="showScreen('items', {categoryId: ${cat.id}})">
                <span class="icon">${cat.icon}</span>
                <span>${cat.name}</span>
                <span class="count">${cat.items_count}</span>
            </button>
        `).join('');

        list.innerHTML = html;
    }

    // Render items
    function renderItems() {
        const list = document.getElementById('items-list');
        let items = allItems.filter(i => i.item_type === currentType);

        if (currentCategoryId !== null) {
            items = items.filter(i => i.category_id === currentCategoryId);
        }

        if (items.length === 0) {
            list.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }

        list.innerHTML = items.map(item => `
            <button class="item-btn" onclick="openItemModal(${item.id})">
                ${item.title}
                <span class="item-pages-count">${item.pages.length} —ç—Ç–∞–ø(–æ–≤)</span>
            </button>
        `).join('');
    }

    // Search context - saved before switching to search screen
    let searchContext = {
        type: null,
        categoryId: null,
        previousScreen: 'main'
    };

    // Search
    function handleSearch() {
        const query = document.getElementById('global-search').value.trim().toLowerCase();

        if (query.length === 0) {
            clearSearch();
            return;
        }

        if (query.length < 2) return;

        // Save search context BEFORE changing screen
        if (currentScreen !== 'search') {
            searchContext = {
                type: currentType,
                categoryId: currentCategoryId,
                previousScreen: currentScreen
            };
        }

        let results = allItems.filter(item => item.title.toLowerCase().includes(query));

        // Filter by type from saved context
        if (searchContext.type) {
            results = results.filter(i => i.item_type === searchContext.type);
        }

        // Filter by category from saved context
        if (searchContext.categoryId !== null) {
            results = results.filter(i => i.category_id === searchContext.categoryId);
        }

        renderSearchResults(results);

        // Switch to search screen without resetting context
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-search').classList.add('active');
        currentScreen = 'search';
    }

    function renderSearchResults(results) {
        const list = document.getElementById('search-results');

        // Update search title to show context
        let searchTitle = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞';
        if (searchContext.categoryId !== null) {
            const cat = categories.find(c => c.id === searchContext.categoryId);
            if (cat) searchTitle = `–ü–æ–∏—Å–∫ –≤ "${cat.icon} ${cat.name}"`;
        } else if (searchContext.type) {
            searchTitle = searchContext.type === 'incident' ? '–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞—Ö' : '–ü–æ–∏—Å–∫ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö';
        }
        document.querySelector('#screen-search .section-title').textContent = searchTitle;

        if (results.length === 0) {
            list.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }

        list.innerHTML = results.map(item => {
            const cat = categories.find(c => c.id === item.category_id);
            const catName = cat ? `${cat.icon} ${cat.name}` : '';
            const typeName = item.item_type === 'incident' ? '–ò–Ω—Ü–∏–¥–µ–Ω—Ç' : '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è';
            return `
                <button class="item-btn" onclick="openItemModal(${item.id})">
                    ${item.title}
                    <span class="item-pages-count">${item.pages.length} —ç—Ç–∞–ø(–æ–≤)</span>
                    <span class="search-result-category">${typeName} ${catName ? '‚Ä¢ ' + catName : ''}</span>
                </button>
            `;
        }).join('');
    }

    function clearSearch() {
        document.getElementById('global-search').value = '';
        // Go back to previous screen using saved context
        if (searchContext.previousScreen === 'items' && searchContext.categoryId !== null) {
            currentType = searchContext.type;
            showScreen('items', { categoryId: searchContext.categoryId });
        } else if (searchContext.previousScreen === 'categories' || searchContext.type) {
            showScreen(searchContext.type === 'incident' ? 'incidents' : 'instructions');
        } else {
            showScreen('main');
        }
    }

    // Modal functions
    function openItemModal(itemId) {
        const item = allItems.find(i => i.id === itemId);
        if (!item) return;

        currentItem = item;
        currentPage = 0;

        checkedActions = currentItem.pages.map(page =>
            new Array(page.actions.length).fill(false)
        );

        document.getElementById('modal-title').textContent = currentItem.title;
        renderModalPage();
        renderPageDots();
        updateProgress();

        document.getElementById('modal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function renderModalPage() {
        const page = currentItem.pages[currentPage];

        document.getElementById('page-title').textContent = page.title;
        document.getElementById('modal-time').textContent = '‚è± ' + page.time;

        const img = document.getElementById('modal-img');
        const noImg = document.getElementById('no-image');
        if (page.image) {
            img.src = page.image;
            img.style.display = 'block';
            noImg.style.display = 'none';
        } else {
            img.style.display = 'none';
            noImg.style.display = 'block';
        }

        const pageChecks = checkedActions[currentPage];
        document.getElementById('actions-container').innerHTML = page.actions.map((action, index) => `
            <div class="action-item ${pageChecks[index] ? 'checked' : ''}" onclick="toggleAction(${index})">
                <div class="action-checkbox">${pageChecks[index] ? '‚úì' : ''}</div>
                <span class="action-number">${index + 1}</span>
                <span class="action-text">${action}</span>
            </div>
        `).join('');

        document.getElementById('page-number').textContent = `${currentPage + 1} / ${currentItem.pages.length}`;
        document.getElementById('prev-btn').disabled = currentPage === 0;

        const nextBtn = document.getElementById('next-btn');
        if (currentPage === currentItem.pages.length - 1) {
            nextBtn.textContent = '‚úì –ì–æ—Ç–æ–≤–æ';
            nextBtn.classList.add('finish');
        } else {
            nextBtn.textContent = '–î–∞–ª–µ–µ ‚Üí';
            nextBtn.classList.remove('finish');
        }
        nextBtn.disabled = false;

        updatePageDots();
        updateProgress();
    }

    function toggleAction(actionIndex) {
        checkedActions[currentPage][actionIndex] = !checkedActions[currentPage][actionIndex];
        renderModalPage();
    }

    function updateProgress() {
        if (!currentItem || !checkedActions.length) return;

        let totalActions = 0;
        let checkedCount = 0;

        currentItem.pages.forEach((page, pageIndex) => {
            totalActions += page.actions.length;
            if (checkedActions[pageIndex]) {
                checkedCount += checkedActions[pageIndex].filter(c => c).length;
            }
        });

        const percent = totalActions > 0 ? (checkedCount / totalActions) * 100 : 0;
        document.getElementById('progress-bar').style.width = percent + '%';
    }

    function isPageCompleted(pageIndex) {
        const pageChecks = checkedActions[pageIndex];
        if (!pageChecks || pageChecks.length === 0) return false;
        return pageChecks.every(c => c);
    }

    function renderPageDots() {
        const dotsContainer = document.getElementById('page-dots');
        dotsContainer.innerHTML = currentItem.pages.map((page, index) => {
            const isActive = index === currentPage;
            const isCompleted = !isActive && isPageCompleted(index);
            return `<div class="page-dot ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
                        onclick="goToPage(${index})"></div>`;
        }).join('');
    }

    function updatePageDots() {
        const dots = document.querySelectorAll('.page-dot');
        dots.forEach((dot, index) => {
            const isActive = index === currentPage;
            const isCompleted = !isActive && isPageCompleted(index);
            dot.classList.toggle('active', isActive);
            dot.classList.toggle('completed', isCompleted);
        });
    }

    function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 0 && newPage < currentItem.pages.length) {
            currentPage = newPage;
            renderModalPage();
        } else if (newPage >= currentItem.pages.length) {
            closeModal('modal');
            showToast('–í—ã–ø–æ–ª–Ω–µ–Ω–æ!', 'success');
        }
    }

    function goToPage(pageIndex) {
        currentPage = pageIndex;
        renderModalPage();
    }

    function closeModalOutside(event) {
        if (event.target.classList.contains('modal-overlay')) {
            closeModal('modal');
        }
    }

    // Swipe support
    document.getElementById('modal-content').addEventListener('touchstart', e => {
        if (e.target.closest('.actions-container')) {
            isSwiping = false;
            return;
        }
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isSwiping = true;
    }, { passive: true });

    document.getElementById('modal-content').addEventListener('touchend', e => {
        if (!isSwiping) return;

        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
        isSwiping = false;
    }, { passive: true });

    function handleSwipe() {
        const swipeThreshold = 50;
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > swipeThreshold) {
            if (diffX > 0) {
                changePage(1);
            } else {
                changePage(-1);
            }
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (!document.getElementById('modal').classList.contains('show')) return;

        if (e.key === 'Escape') {
            closeModal('modal');
            document.body.style.overflow = '';
        } else if (e.key === 'ArrowLeft') {
            changePage(-1);
        } else if (e.key === 'ArrowRight') {
            changePage(1);
        }
    });

    // Fullscreen
    function toggleFullscreen() {
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }
    }

    function updateFullscreenButton() {
        const btn = document.getElementById('fullscreen-btn');
        if (document.fullscreenElement || document.webkitFullscreenElement) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    }

    document.addEventListener('fullscreenchange', updateFullscreenButton);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
</script>
{% endblock %}
