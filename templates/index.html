{% extends "base.html" %}

{% block title %}База знаний производства{% endblock %}

{% block extra_css %}
<style>
    :root {
        --color-danger: #D32F2F;
        --color-danger-dark: #B71C1C;
        --color-success: #388E3C;
        --color-success-dark: #1B5E20;
        --color-primary: #1976D2;
        --color-primary-dark: #0D47A1;
        --color-warning: #F57C00;
        --color-warning-dark: #E65100;
        --color-dark: #263238;
        --color-darker: #1a1a2e;
    }

    body {
        background: linear-gradient(135deg, var(--color-darker) 0%, #16213e 100%);
        color: #fff;
        overflow-x: hidden;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }

    h1 {
        font-size: 1.8rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .fullscreen-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
        min-height: 56px;
    }

    .fullscreen-btn:hover, .fullscreen-btn:active {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.02);
    }

    .fullscreen-btn.active {
        background: rgba(56, 142, 60, 0.6);
        border-color: var(--color-success);
    }

    /* Main buttons - large touch targets */
    .main-buttons {
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 30px;
    }

    .main-btn {
        padding: 32px 48px;
        font-size: 1.6rem;
        font-weight: bold;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 280px;
        min-height: 100px;
        text-transform: uppercase;
        letter-spacing: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .main-btn.incidents {
        background: linear-gradient(135deg, var(--color-danger) 0%, var(--color-danger-dark) 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(211, 47, 47, 0.5);
    }

    .main-btn.incidents:hover, .main-btn.incidents.active {
        transform: translateY(-4px);
        box-shadow: 0 12px 35px rgba(211, 47, 47, 0.7);
    }

    .main-btn.instructions {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(25, 118, 210, 0.5);
    }

    .main-btn.instructions:hover, .main-btn.instructions.active {
        transform: translateY(-4px);
        box-shadow: 0 12px 35px rgba(25, 118, 210, 0.7);
    }

    /* List panel */
    .list-panel {
        display: none;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 20px;
        animation: slideDown 0.3s ease;
    }

    .list-panel.show {
        display: block;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .search-box {
        width: 100%;
        padding: 20px 28px;
        font-size: 1.3rem;
        border: none;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        margin-bottom: 20px;
        min-height: 64px;
    }

    .search-box::placeholder {
        color: #666;
    }

    .search-box:focus {
        outline: none;
        box-shadow: 0 0 0 4px rgba(25, 118, 210, 0.5);
    }

    /* Item buttons */
    .items-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }

    .item-btn {
        padding: 24px 28px;
        font-size: 1.25rem;
        font-weight: 500;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .item-btn:hover, .item-btn:active {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.02);
    }

    .item-btn.incident-item {
        border-left: 6px solid var(--color-danger);
    }

    .item-btn.instruction-item {
        border-left: 6px solid var(--color-primary);
    }

    .item-pages-count {
        display: block;
        font-size: 1rem;
        color: rgba(255,255,255,0.7);
        margin-top: 8px;
    }

    .no-results {
        text-align: center;
        padding: 40px;
        color: rgba(255,255,255,0.6);
        font-size: 1.3rem;
        grid-column: 1 / -1;
    }

    /* ========== FULLSCREEN MODAL ========== */
    .modal-overlay {
        background: rgba(0, 0, 0, 0.95);
        padding: 0;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #fff;
    }

    /* Header - fixed */
    .modal-header {
        background: linear-gradient(135deg, var(--color-warning) 0%, var(--color-warning-dark) 100%);
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        min-height: 70px;
    }

    .modal-header h2 {
        font-size: 1.4rem;
        margin: 0;
        flex: 1;
    }

    .back-btn {
        background: rgba(255, 255, 255, 0.25);
        border: none;
        color: white;
        padding: 14px 28px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 600;
        min-height: 52px;
        min-width: 120px;
        transition: background 0.3s;
    }

    .back-btn:hover, .back-btn:active {
        background: rgba(255, 255, 255, 0.4);
    }

    /* Progress bar */
    .progress-container {
        background: #e0e0e0;
        height: 8px;
        flex-shrink: 0;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-success) 0%, #4CAF50 100%);
        transition: width 0.3s ease;
    }

    /* Main content area */
    .modal-main {
        flex: 1;
        display: flex;
        overflow: hidden;
        background: #f5f5f5;
    }

    /* Image side */
    .modal-image-side {
        flex: 0 0 40%;
        max-width: 40%;
        background: var(--color-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-image-side img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 12px;
    }

    .no-image {
        color: rgba(255,255,255,0.3);
        font-size: 1.2rem;
        text-align: center;
    }

    /* Content side */
    .modal-content-side {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Page info */
    .page-info {
        padding: 16px 24px;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
        flex-shrink: 0;
    }

    .page-title {
        font-size: 1.4rem;
        color: #333;
        margin: 0 0 8px 0;
        font-weight: 600;
    }

    .time-badge {
        display: inline-block;
        background: var(--color-primary);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 500;
    }

    /* Actions list with checkboxes */
    .actions-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
    }

    .action-item {
        background: #fff;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid #e0e0e0;
        min-height: 64px;
    }

    .action-item:hover {
        border-color: var(--color-primary);
    }

    .action-item.checked {
        background: #E8F5E9;
        border-color: var(--color-success);
    }

    .action-checkbox {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid #bbb;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.2rem;
        color: transparent;
        transition: all 0.2s;
    }

    .action-item.checked .action-checkbox {
        background: var(--color-success);
        border-color: var(--color-success);
        color: white;
    }

    .action-number {
        background: var(--color-primary);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .action-item.checked .action-number {
        background: var(--color-success);
    }

    .action-text {
        flex: 1;
        font-size: 1.15rem;
        color: #333;
        line-height: 1.4;
    }

    .action-item.checked .action-text {
        color: var(--color-success-dark);
    }

    /* Navigation - fixed bottom */
    .modal-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: #fff;
        border-top: 1px solid #e0e0e0;
        flex-shrink: 0;
        gap: 16px;
    }

    .nav-btn {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
        border: none;
        color: white;
        padding: 18px 36px;
        border-radius: 14px;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        min-height: 60px;
        min-width: 140px;
        transition: all 0.3s;
    }

    .nav-btn:hover:not(:disabled), .nav-btn:active:not(:disabled) {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
    }

    .nav-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .nav-btn.finish {
        background: linear-gradient(135deg, var(--color-success) 0%, var(--color-success-dark) 100%);
    }

    .page-indicator-bottom {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 12px;
    }

    #page-dots {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
    }

    .page-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .page-dot.active {
        background: var(--color-warning);
        transform: scale(1.3);
    }

    .page-dot.completed {
        background: var(--color-success);
    }

    .page-number-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        min-width: 80px;
        text-align: center;
    }

    /* Responsive - Tablet portrait */
    @media (max-width: 900px) {
        .modal-main {
            flex-direction: column;
        }

        .modal-image-side {
            flex: 0 0 35%;
            max-width: 100%;
            max-height: 35%;
        }

        .modal-content-side {
            flex: 1;
        }

        .action-item {
            padding: 14px 16px;
        }
    }

    @media (max-width: 600px) {
        .main-btn {
            width: 100%;
            min-width: unset;
        }

        h1 {
            font-size: 1.4rem;
        }

        .modal-header h2 {
            font-size: 1.2rem;
        }

        .nav-btn {
            padding: 14px 20px;
            min-width: 100px;
            font-size: 1rem;
        }

        .modal-image-side {
            flex: 0 0 30%;
            max-height: 30%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>База знаний</h1>
        <button class="fullscreen-btn" onclick="toggleFullscreen()" id="fullscreen-btn">
            <span id="fullscreen-icon">⛶</span>
            <span id="fullscreen-text">Полный экран</span>
        </button>
    </div>

    <div class="main-buttons">
        <button class="main-btn incidents" onclick="togglePanel('incidents')">
            Инциденты
        </button>
        <button class="main-btn instructions" onclick="togglePanel('instructions')">
            Инструкции
        </button>
    </div>

    <div id="incidents-panel" class="list-panel">
        <input type="text" class="search-box" placeholder="Поиск инцидента..." oninput="filterItems('incidents')">
        <div class="items-list" id="incidents-list"></div>
    </div>

    <div id="instructions-panel" class="list-panel">
        <input type="text" class="search-box" placeholder="Поиск инструкции..." oninput="filterItems('instructions')">
        <div class="items-list" id="instructions-list"></div>
    </div>
</div>

<!-- Fullscreen Modal -->
<div class="modal-overlay" id="modal" onclick="closeModalOutside(event)">
    <div class="modal" id="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Заголовок</h2>
            <button class="back-btn" onclick="closeModal('modal')">✕ Закрыть</button>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>

        <div class="modal-main">
            <div class="modal-image-side">
                <img id="modal-img" src="" alt="Изображение">
                <div class="no-image" id="no-image" style="display: none;">Нет изображения</div>
            </div>

            <div class="modal-content-side">
                <div class="page-info">
                    <h3 class="page-title" id="page-title">Название этапа</h3>
                    <span class="time-badge" id="modal-time">⏱ 5 минут</span>
                </div>

                <div class="actions-container" id="actions-container">
                    <!-- Actions will be rendered here -->
                </div>
            </div>
        </div>

        <div class="modal-navigation">
            <button class="nav-btn" id="prev-btn" onclick="changePage(-1)">← Назад</button>

            <div class="page-indicator-bottom">
                <div id="page-dots"></div>
                <span class="page-number-text" id="page-number">1 / 3</span>
            </div>

            <button class="nav-btn" id="next-btn" onclick="changePage(1)">Далее →</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Data from server
    let incidentsData = {{ incidents | tojson | safe }};
    let instructionsData = {{ instructions | tojson | safe }};

    let currentPanel = null;
    let currentItem = null;
    let currentPage = 0;
    let checkedActions = []; // Array of arrays: checkedActions[pageIndex][actionIndex] = true/false

    // Swipe support
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isSwiping = false;

    function togglePanel(type) {
        const incidentsPanel = document.getElementById('incidents-panel');
        const instructionsPanel = document.getElementById('instructions-panel');
        const incidentsBtn = document.querySelector('.main-btn.incidents');
        const instructionsBtn = document.querySelector('.main-btn.instructions');

        if (type === 'incidents') {
            if (currentPanel === 'incidents') {
                incidentsPanel.classList.remove('show');
                incidentsBtn.classList.remove('active');
                currentPanel = null;
            } else {
                incidentsPanel.classList.add('show');
                instructionsPanel.classList.remove('show');
                incidentsBtn.classList.add('active');
                instructionsBtn.classList.remove('active');
                currentPanel = 'incidents';
                renderItems('incidents', incidentsData);
            }
        } else {
            if (currentPanel === 'instructions') {
                instructionsPanel.classList.remove('show');
                instructionsBtn.classList.remove('active');
                currentPanel = null;
            } else {
                instructionsPanel.classList.add('show');
                incidentsPanel.classList.remove('show');
                instructionsBtn.classList.add('active');
                incidentsBtn.classList.remove('active');
                currentPanel = 'instructions';
                renderItems('instructions', instructionsData);
            }
        }
    }

    function renderItems(type, data) {
        const list = document.getElementById(`${type}-list`);
        const itemClass = type === 'incidents' ? 'incident-item' : 'instruction-item';

        if (data.length === 0) {
            list.innerHTML = '<div class="no-results">Ничего не найдено</div>';
            return;
        }

        list.innerHTML = data.map((item, index) => `
            <button class="item-btn ${itemClass}" onclick="openModal(${index}, '${type}')">
                ${item.title}
                <span class="item-pages-count">${item.pages.length} этап(ов)</span>
            </button>
        `).join('');
    }

    function filterItems(type) {
        const searchBox = document.querySelector(`#${type}-panel .search-box`);
        const query = searchBox.value.toLowerCase();
        const data = type === 'incidents' ? incidentsData : instructionsData;

        const filtered = data.filter(item =>
            item.title.toLowerCase().includes(query)
        );

        renderItems(type, filtered);
    }

    function openModal(index, type) {
        const data = type === 'incidents' ? incidentsData : instructionsData;
        currentItem = data[index];
        currentPage = 0;

        // Initialize checkedActions array for all pages
        checkedActions = currentItem.pages.map(page =>
            new Array(page.actions.length).fill(false)
        );

        document.getElementById('modal-title').textContent = currentItem.title;
        renderPage();
        renderPageDots();
        updateProgress();

        document.getElementById('modal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function renderPage() {
        const page = currentItem.pages[currentPage];

        document.getElementById('page-title').textContent = page.title;
        document.getElementById('modal-time').textContent = '⏱ ' + page.time;

        // Image
        const img = document.getElementById('modal-img');
        const noImg = document.getElementById('no-image');
        if (page.image) {
            img.src = page.image;
            img.style.display = 'block';
            noImg.style.display = 'none';
        } else {
            img.style.display = 'none';
            noImg.style.display = 'block';
        }

        // Actions with checkboxes
        const pageChecks = checkedActions[currentPage];
        document.getElementById('actions-container').innerHTML = page.actions.map((action, index) => `
            <div class="action-item ${pageChecks[index] ? 'checked' : ''}" onclick="toggleAction(${index})">
                <div class="action-checkbox">${pageChecks[index] ? '✓' : ''}</div>
                <span class="action-number">${index + 1}</span>
                <span class="action-text">${action}</span>
            </div>
        `).join('');

        // Navigation
        document.getElementById('page-number').textContent = `${currentPage + 1} / ${currentItem.pages.length}`;
        document.getElementById('prev-btn').disabled = currentPage === 0;

        const nextBtn = document.getElementById('next-btn');
        if (currentPage === currentItem.pages.length - 1) {
            nextBtn.textContent = '✓ Готово';
            nextBtn.classList.add('finish');
        } else {
            nextBtn.textContent = 'Далее →';
            nextBtn.classList.remove('finish');
        }
        nextBtn.disabled = false;

        updatePageDots();
        updateProgress();
    }

    function toggleAction(actionIndex) {
        checkedActions[currentPage][actionIndex] = !checkedActions[currentPage][actionIndex];
        renderPage();
    }

    function updateProgress() {
        if (!currentItem || !checkedActions.length) return;

        let totalActions = 0;
        let checkedCount = 0;

        currentItem.pages.forEach((page, pageIndex) => {
            totalActions += page.actions.length;
            if (checkedActions[pageIndex]) {
                checkedCount += checkedActions[pageIndex].filter(c => c).length;
            }
        });

        const percent = totalActions > 0 ? (checkedCount / totalActions) * 100 : 0;
        document.getElementById('progress-bar').style.width = percent + '%';
    }

    function isPageCompleted(pageIndex) {
        const pageChecks = checkedActions[pageIndex];
        if (!pageChecks || pageChecks.length === 0) return false;
        // Page is completed only if all actions are checked
        return pageChecks.every(c => c);
    }

    function renderPageDots() {
        const dotsContainer = document.getElementById('page-dots');
        dotsContainer.innerHTML = currentItem.pages.map((page, index) => {
            const isActive = index === currentPage;
            const isCompleted = !isActive && isPageCompleted(index);
            return `<div class="page-dot ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
                        onclick="goToPage(${index})"></div>`;
        }).join('');
    }

    function updatePageDots() {
        const dots = document.querySelectorAll('.page-dot');
        dots.forEach((dot, index) => {
            const isActive = index === currentPage;
            const isCompleted = !isActive && isPageCompleted(index);
            dot.classList.toggle('active', isActive);
            dot.classList.toggle('completed', isCompleted);
        });
    }

    function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 0 && newPage < currentItem.pages.length) {
            currentPage = newPage;
            renderPage();
        } else if (newPage >= currentItem.pages.length) {
            // Finished
            closeModal('modal');
            showToast('Выполнено!', 'success');
        }
    }

    function goToPage(pageIndex) {
        currentPage = pageIndex;
        renderPage();
    }

    function closeModalOutside(event) {
        if (event.target.classList.contains('modal-overlay')) {
            closeModal('modal');
        }
    }

    // Swipe support - only horizontal swipes, ignore vertical scrolling
    document.getElementById('modal-content').addEventListener('touchstart', e => {
        // Don't track swipes that start in the scrollable actions area
        if (e.target.closest('.actions-container')) {
            isSwiping = false;
            return;
        }
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isSwiping = true;
    }, { passive: true });

    document.getElementById('modal-content').addEventListener('touchend', e => {
        if (!isSwiping) return;

        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
        isSwiping = false;
    }, { passive: true });

    function handleSwipe() {
        const swipeThreshold = 50;
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;

        // Only handle horizontal swipes (X movement > Y movement)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > swipeThreshold) {
            if (diffX > 0) {
                changePage(1);
            } else {
                changePage(-1);
            }
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (!document.getElementById('modal').classList.contains('show')) return;

        if (e.key === 'Escape') {
            closeModal('modal');
            document.body.style.overflow = '';
        } else if (e.key === 'ArrowLeft') {
            changePage(-1);
        } else if (e.key === 'ArrowRight') {
            changePage(1);
        }
    });

    // Fullscreen functionality
    function toggleFullscreen() {
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }
    }

    function updateFullscreenButton() {
        const btn = document.getElementById('fullscreen-btn');
        const icon = document.getElementById('fullscreen-icon');
        const text = document.getElementById('fullscreen-text');

        if (document.fullscreenElement || document.webkitFullscreenElement) {
            btn.classList.add('active');
            icon.textContent = '⛶';
            text.textContent = 'Выйти';
        } else {
            btn.classList.remove('active');
            icon.textContent = '⛶';
            text.textContent = 'Полный экран';
        }
    }

    document.addEventListener('fullscreenchange', updateFullscreenButton);
    document.addEventListener('webkitfullscreenchange', updateFullscreenButton);

    // Refresh data from API
    async function refreshData() {
        try {
            const [incidents, instructions] = await Promise.all([
                api('/incidents'),
                api('/instructions')
            ]);
            incidentsData = incidents;
            instructionsData = instructions;
            if (currentPanel) {
                renderItems(currentPanel, currentPanel === 'incidents' ? incidentsData : instructionsData);
            }
        } catch (error) {
            console.error('Failed to refresh data:', error);
        }
    }
</script>
{% endblock %}
